<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fictitious Holiday Calendar & Social App</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Bangers&family=Inter:wght@400;600&display=swap" rel="stylesheet">
    
    <!-- Inlining custom styles to avoid file loading errors -->
    <style>
        body {
            background-color: #f7f1e3;
            font-family: 'Inter', sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 1rem;
        }
        #root {
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
    </style>
    
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp, getApps } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, addDoc, doc, setDoc, query, where, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        window.firebaseApp = { initializeApp, getApps };
        window.firebaseAuth = { getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged };
        window.firestore = { getFirestore, collection, onSnapshot, addDoc, doc, setDoc, query, where, serverTimestamp };
    </script>
    
    <!-- React and Babel for running the app -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body>
    <div id="root"></div>

    <!-- The entire application code in one script block -->
    <script type="text/babel">
        // --- FAKE HOLIDAY DATA ---
        const fakeHolidays = {
            "2025-01-07": { reason: "International Day of Forgetting Your Own Birthday. Celebrate by pretending you don't know it's your day.", sarcastic: "You got fooled! There's no such thing. Get back to work, buddy." },
            "2025-02-14": { reason: "Galactic Gumdrop Day. A day to contemplate if gumdrops exist in other galaxies. (They don't.)", sarcastic: "Sarcastic message: Just another excuse to eat candy. Now get back to reality!" },
            "2025-03-12": { reason: "International Day of Remembering That Guy From Chemistry Class. You know, the one with the weird lab coat stain.", sarcastic: "You got fooled! Go for work buddy." },
            "2025-04-01": { reason: "Silly Sock Day. Wear your most ridiculous socks. Everyone will be too embarrassed to tell you to take them off.", sarcastic: "Sarcastic message: Seriously? You're wearing those? April Fools!" },
            "2025-04-20": { reason: "Bus Strike Day. A day to walk everywhere, because the buses decided to take a day off.", sarcastic: "Sarcastic message: The bus isn't on strike. You just missed it. Time to run!" },
            "2025-05-18": { reason: "Talk Like a Robot Day. Communicate exclusively in a monotone voice. Beep boop.", sarcastic: "Sarcastic message: Error 404. Holiday not found. Resume normal human communication." },
            "2025-06-03": { reason: "Annual Air-Guitar Championship. Shred all day on your imaginary guitar. No one can prove you're not a rock star.", sarcastic: "Sarcastic message: Your air guitar is terrible. Go practice!" },
            "2025-07-22": { reason: "Under-the-Blanket Fort Day. It's a day to build a magnificent fort. You're an adult. Don't let anyone tell you otherwise.", sarcastic: "Sarcastic message: That's just your bed. Get up and face the day." },
            "2025-08-11": { reason: "Whispering Wednesday. The art of whispering is practiced all day. Loud noises are strictly forbidden. Shhhh.", sarcastic: "Sarcastic message: The holiday police don't exist. SHOUT IF YOU WANT TO!" },
            "2025-09-09": { reason: "First Day of Second Autumn. A totally made-up holiday because one autumn isn't enough. Time to get a second pumpkin spice latte.", sarcastic: "Sarcastic message: Autumn is over. It's almost winter. Stop trying to make 'Second Autumn' happen." },
            "2025-09-15": { reason: "KTU Site Crash Day. All classes are canceled because nobody can log in to the student portal.", sarcastic: "Sarcastic message: The site is back up. You just missed the deadline." },
            "2025-10-31": { reason: "Happy Haunting Day. A spookier, more festive version of a well-known holiday.", sarcastic: "Sarcastic message: You are fooled! The trick is on you. There's no treat." },
            "2025-11-05": { reason: "504 Gateway Timeout Day. A nationwide holiday for when the KTU site is down. Again.", sarcastic: "Sarcastic message: The gateway timed out... but your professor's patience hasn't. Get to class!" },
            "2025-11-23": { reason: "Appreciation of Left Socks Day. A heartfelt tribute to all the single left socks who have lost their partners in the laundry vortex.", sarcastic: "Sarcastic message: Your dryer is a sock monster. Deal with it." },
            "2025-12-25": { reason: "Puzzling Present Day. You can only give presents that are wrapped in so many layers of tape and paper that it takes hours to open.", sarcastic: "Sarcastic message: The real holiday is figuring out how to get that tape off without a knife. Have fun!" },
            "2025-12-31": { reason: "New Year's Eve (Minus the Party). A day to reflect quietly on the past year without any annoying celebrations or resolutions.", sarcastic: "Sarcastic message: You're just antisocial. Go to a party!" },
            "2025-12-05": { reason: "Holiday because the college got fired. A day to celebrate the liberation of students from boring lectures.", sarcastic: "Sarcastic message: Sorry, the college is still here. You just got a fake news alert. Back to class!" },
            "2025-10-10": { reason: "Uniform did not get dry. A day to wear whatever you want because your uniform is still wet.", sarcastic: "Sarcastic message: Just wear the wet uniform, it will dry on you. Get going!" }
        };

        const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];

        const { useState, useEffect, useRef } = React;
        const { initializeApp, getApps } = firebaseApp;
        const { getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged } = firebaseAuth;
        const { getFirestore, collection, onSnapshot, addDoc, doc, setDoc, query, where, serverTimestamp } = firestore;

        // Define the global Firebase variables to be populated by the Canvas environment
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        // --- MAIN APP COMPONENT ---
        const App = () => {
            const [page, setPage] = useState('home');
            const [selectedDate, setSelectedDate] = useState(null);
            const [db, setDb] = useState(null);
            const [auth, setAuth] = useState(null);
            const [userId, setUserId] = useState(null);
            const [isAuthReady, setIsAuthReady] = useState(false);

            // Initialize Firebase
            useEffect(() => {
                let firebaseApp;
                try {
                    if (!getApps().length) {
                        firebaseApp = initializeApp(firebaseConfig);
                    }
                    const firestoreDb = getFirestore(firebaseApp);
                    const firebaseAuth = getAuth(firebaseApp);
                    setDb(firestoreDb);
                    setAuth(firebaseAuth);

                    onAuthStateChanged(firebaseAuth, async (user) => {
                        if (user) {
                            setUserId(user.uid);
                            setIsAuthReady(true);
                        } else {
                            try {
                                if (initialAuthToken) {
                                    await signInWithCustomToken(firebaseAuth, initialAuthToken);
                                } else {
                                    await signInAnonymously(firebaseAuth);
                                    const anonymousUser = firebaseAuth.currentUser;
                                    setUserId(anonymousUser?.uid || crypto.randomUUID());
                                }
                            } catch (error) {
                                console.error("Firebase sign-in error:", error);
                                // Fallback to anonymous ID if sign-in fails
                                setUserId(crypto.randomUUID());
                            } finally {
                                 setIsAuthReady(true);
                            }
                        }
                    });
                } catch (e) {
                    console.error("Failed to initialize Firebase:", e);
                    setUserId(crypto.randomUUID());
                    setIsAuthReady(true);
                }
            }, []);

            // --- PAGE NAVIGATION ---
            const renderPage = () => {
                switch (page) {
                    case 'home':
                        return <HomePage setPage={setPage} setSelectedDate={setSelectedDate} />;
                    case 'monthly':
                        return <MonthlyCalendar date={selectedDate} setPage={setPage} userId={userId} db={db} isAuthReady={isAuthReady} />;
                    case 'friends':
                        return <FriendsPage setPage={setPage} userId={userId} db={db} isAuthReady={isAuthReady} />;
                    default:
                        return <HomePage setPage={setPage} setSelectedDate={setSelectedDate} />;
                }
            };

            return (
                <div className="bg-[#F7F1E3] font-[Inter] min-h-screen p-4 flex flex-col items-center justify-center">
                    {isAuthReady && userId && (
                         <div className="text-sm text-gray-500 mb-2">User ID: {userId}</div>
                    )}
                    <nav className="flex justify-center space-x-4 mb-8">
                        <button onClick={() => setPage('home')} className="px-4 py-2 bg-[#D63031] text-white font-bold rounded-lg hover:bg-red-700 transition-colors">Home</button>
                        <button onClick={() => setPage('friends')} className="px-4 py-2 bg-[#D63031] text-white font-bold rounded-lg hover:bg-red-700 transition-colors">Friends</button>
                    </nav>
                    {renderPage()}
                </div>
            );
        };

        // --- HOME PAGE COMPONENT ---
        const HomePage = ({ setPage, setSelectedDate }) => {
            const months = [...Array(12).keys()];
            const currentYear = new Date().getFullYear();

            const handleMonthClick = (month) => {
                setSelectedDate(new Date(currentYear, month, 1));
                setPage('monthly');
            };

            return (
                <div className="bg-white rounded-xl shadow-xl p-8 max-w-6xl w-full">
                    <h1 className="text-6xl font-['Bangers'] text-[#D63031] mb-8 text-center" style={{ textShadow: '2px 2px #fff' }}>2025</h1>
                    <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-8">
                        {months.map(month => (
                            <div
                                key={month}
                                onClick={() => handleMonthClick(month)}
                                className="bg-[#F8F4EE] p-4 rounded-lg shadow-md cursor-pointer hover:bg-[#EFEAE3] transition-colors"
                            >
                                <h3 className="text-xl font-['Bangers'] text-[#D63031] mb-2">{monthNames[month]}</h3>
                                <div className="grid grid-cols-7 text-center text-sm text-gray-500">
                                    <div>S</div><div>M</div><div>T</div><div>W</div><div>T</div><div>F</div><div>S</div>
                                </div>
                                <div className="grid grid-cols-7 gap-1 text-center text-sm mt-2">
                                    {/* Simple placeholder grid */}
                                    {[...Array(new Date(currentYear, month + 1, 0).getDate()).keys()].map(day => (
                                        <span key={day} className="w-6 h-6 flex items-center justify-center">
                                            {day + 1}
                                        </span>
                                    ))}
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        // --- MONTHLY CALENDAR COMPONENT ---
        const MonthlyCalendar = ({ date, setPage, userId, db, isAuthReady }) => {
            const [currentDate, setCurrentDate] = useState(date || new Date());
            const [modal, setModal] = useState({ isOpen: false, message: '', sarcastic: false });
            const [reminders, setReminders] = useState([]);
            const [newReminder, setNewReminder] = useState('');
            const messageTimer = useRef(null);

            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();

            // Fetch reminders from Firestore
            useEffect(() => {
                if (!isAuthReady || !db || !userId) return;

                const remindersCollectionRef = collection(db, 'artifacts', appId, 'users', userId, 'reminders');
                const q = query(remindersCollectionRef);
                const unsubscribe = onSnapshot(q, (snapshot) => {
                    const fetchedReminders = snapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));
                    setReminders(fetchedReminders);
                }, (error) => {
                    console.error("Error fetching reminders:", error);
                });

                return () => unsubscribe();
            }, [isAuthReady, db, userId]);

            // Calendar rendering logic
            const renderCalendar = () => {
                const firstDayOfMonth = new Date(year, month, 1).getDay();
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                const calendarCells = [];

                // Add blank days
                for (let i = 0; i < firstDayOfMonth; i++) {
                    calendarCells.push(<div key={`blank-${i}`} className="h-16"></div>);
                }

                // Add days of the month
                for (let day = 1; day <= daysInMonth; day++) {
                    const dateString = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                    const isHoliday = fakeHolidays[dateString];
                    const isToday = day === new Date().getDate() && month === new Date().getMonth() && year === new Date().getFullYear();
                    
                    let cellClasses = "day-cell h-16 flex flex-col justify-center items-center text-xl font-bold rounded-lg transition-colors";
                    
                    if (isHoliday) {
                        cellClasses += " bg-[#D63031] text-white cursor-pointer hover:bg-red-700";
                    } else if (isToday) {
                        cellClasses += " bg-gray-200 text-gray-800 border-2 border-gray-400";
                    } else {
                        cellClasses += " bg-[#F8F4EE] text-gray-800 hover:bg-[#EFEAE3]";
                    }

                    calendarCells.push(
                        <div
                            key={dateString}
                            className={cellClasses}
                            onClick={() => isHoliday && showHolidayModal(dateString)}
                        >
                            <span>{day}</span>
                        </div>
                    );
                }

                return calendarCells;
            };

            // Show modal with holiday message
            const showHolidayModal = (dateString) => {
                const holiday = fakeHolidays[dateString];
                if (holiday) {
                    setModal({ isOpen: true, message: holiday.reason, sarcastic: false });
                    // Start a timer to change the message
                    if (messageTimer.current) clearTimeout(messageTimer.current);
                    messageTimer.current = setTimeout(() => {
                        setModal(prev => ({ ...prev, message: holiday.sarcastic, sarcastic: true }));
                    }, 3000); // 3 seconds
                }
            };

            const closeModal = () => {
                setModal({ isOpen: false, message: '', sarcastic: false });
                if (messageTimer.current) clearTimeout(messageTimer.current);
            };

            // Handle reminders
            const handleAddReminder = async () => {
                if (!newReminder.trim() || !db || !userId) return;
                try {
                    const remindersCollectionRef = collection(db, 'artifacts', appId, 'users', userId, 'reminders');
                    await addDoc(remindersCollectionRef, {
                        text: newReminder,
                        createdAt: serverTimestamp()
                    });
                    setNewReminder('');
                } catch (error) {
                    console.error("Error adding reminder:", error);
                }
            };

            return (
                <div className="bg-white rounded-xl shadow-xl p-8 max-w-4xl w-full">
                    <button onClick={() => setPage('home')} className="mb-4 text-sm text-[#D63031] hover:underline">
                        &larr; Back to Year View
                    </button>
                    <div className="flex justify-between items-center mb-6">
                        <button onClick={() => setCurrentDate(new Date(year, month - 1, 1))} className="text-3xl text-[#D63031] hover:text-red-700 transition-colors">&lt;</button>
                        <h2 className="text-5xl font-['Bangers'] text-[#D63031]">{monthNames[month]} {year}</h2>
                        <button onClick={() => setCurrentDate(new Date(year, month + 1, 1))} className="text-3xl text-[#D63031] hover:text-red-700 transition-colors">&gt;</button>
                    </div>
                    <div className="grid grid-cols-7 text-center text-sm font-semibold text-gray-500 mb-2">
                        <div>S</div><div>M</div><div>T</div><div>W</div><div>T</div><div>F</div><div>S</div>
                    </div>
                    <div id="calendar-grid" className="grid grid-cols-7 gap-2">
                        {renderCalendar()}
                    </div>

                    {/* Reminders section */}
                    <div className="mt-8">
                        <h3 className="text-2xl font-bold text-[#D63031] mb-4">Set a Reminder</h3>
                        <div className="flex mb-4">
                            <input
                                type="text"
                                value={newReminder}
                                onChange={(e) => setNewReminder(e.target.value)}
                                placeholder="e.g., Don't forget to relax!"
                                className="flex-grow p-2 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-[#D63031]"
                            />
                            <button onClick={handleAddReminder} className="ml-2 px-4 py-2 bg-[#D63031] text-white rounded-lg hover:bg-red-700">Add</button>
                        </div>
                        {reminders.length > 0 && (
                            <ul className="list-disc pl-5 text-gray-700">
                                {reminders.map(r => (
                                    <li key={r.id} className="text-lg mb-1">{r.text}</li>
                                ))}
                            </ul>
                        )}
                    </div>

                    {/* Holiday Modal */}
                    {modal.isOpen && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4">
                            <div className={`bg-white rounded-xl shadow-2xl p-8 max-w-md w-full transition-all duration-300 transform ${modal.sarcastic ? 'scale-110' : 'scale-100'}`}>
                                <p className={`text-2xl font-bold ${modal.sarcastic ? 'text-[#D63031]' : 'text-gray-800'}`}>
                                    {modal.message}
                                </p>
                                <button onClick={closeModal} className="mt-4 px-4 py-2 bg-[#D63031] text-white rounded-lg hover:bg-red-700">Close</button>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // --- FRIENDS PAGE COMPONENT ---
        const FriendsPage = ({ setPage, userId, db, isAuthReady }) => {
            const [friendId, setFriendId] = useState('');
            const [message, setMessage] = useState('');
            const [messages, setMessages] = useState([]);

            // Fetch messages from Firestore
            useEffect(() => {
                if (!isAuthReady || !db || !userId) return;

                const messagesCollectionRef = collection(db, 'artifacts', appId, 'public', 'data', 'messages');
                const q = query(messagesCollectionRef, where('recipientId', '==', userId));
                const unsubscribe = onSnapshot(q, (snapshot) => {
                    const fetchedMessages = snapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));
                    setMessages(fetchedMessages);
                }, (error) => {
                    console.error("Error fetching messages:", error);
                });

                return () => unsubscribe();
            }, [isAuthReady, db, userId]);

            const handleSendMessage = async () => {
                if (!friendId.trim() || !message.trim() || !db || !userId) return;

                try {
                    const messagesCollectionRef = collection(db, 'artifacts', appId, 'public', 'data', 'messages');
                    await addDoc(messagesCollectionRef, {
                        senderId: userId,
                        recipientId: friendId,
                        message: message,
                        createdAt: serverTimestamp()
                    });
                    setMessage('');
                } catch (error) {
                    console.error("Error sending message:", error);
                }
            };

            return (
                <div className="bg-white rounded-xl shadow-xl p-8 max-w-2xl w-full">
                    <h2 className="text-4xl font-['Bangers'] text-[#D63031] mb-6 text-center">Send Fake Holiday Messages</h2>
                    <div className="mb-6">
                        <label className="block text-lg font-bold text-[#D63031] mb-2">Friend's User ID</label>
                        <input
                            type="text"
                            value={friendId}
                            onChange={(e) => setFriendId(e.target.value)}
                            placeholder="Enter friend's User ID here"
                            className="w-full p-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-[#D63031]"
                        />
                    </div>
                    <div className="mb-6">
                        <label className="block text-lg font-bold text-[#D63031] mb-2">Message</label>
                        <textarea
                            value={message}
                            onChange={(e) => setMessage(e.target.value)}
                            placeholder="Write a sarcastic fake holiday message..."
                            rows="4"
                            className="w-full p-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-[#D63031]"
                        ></textarea>
                    </div>
                    <button onClick={handleSendMessage} className="w-full px-4 py-3 bg-[#D63031] text-white font-bold rounded-lg hover:bg-red-700">
                        Send Message
                    </button>

                    <div className="mt-8">
                        <h3 className="text-2xl font-bold text-[#D63031] mb-4">Messages for You</h3>
                        {messages.length > 0 ? (
                            <ul className="space-y-4">
                                {messages.map((msg, index) => (
                                    <li key={index} className="bg-[#F8F4EE] p-4 rounded-lg shadow">
                                        <p className="text-gray-700">{msg.message}</p>
                                        <p className="text-sm text-gray-500 mt-2">From: {msg.senderId}</p>
                                    </li>
                                ))}
                            </ul>
                        ) : (
                            <p className="text-gray-500">No new messages.</p>
                        )}
                    </div>
                </div>
            );
        };

        // Render the main app component
        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>
